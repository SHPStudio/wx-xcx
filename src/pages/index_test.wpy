<style lang="less">
</style>
<template>
    <view class="container">
        <repeat for="{{dataList}}" index="index" item="item" key="key">
          <single :item="item"></single>
        </repeat>
        <block wx:if="{{noData}}">已经到底啦</block>
    </view>
    <zanDialog/>
</template>

<script>
  import wepy from 'wepy'
  import Single from '../components/single/single'
  import zanDialog from '../components/dialog/zan-dialog'
  import UserInfoMixin from '../mixins/user-info'

  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '首页',
      enablePullDownRefresh: true,
      onReachBottomDistance: 1
    }

    components = {
      single: Single,
      zanDialog,
    }

    data = {
        dataList: [
        ],
        userInfo: {
          code: {},
          user: {}
        },
        page: {
          pageIndex: 1,
          pageSize: 5,
          totalPage: 0
        },
        noData: false
    }

    methods = {
    }

    mixins= [UserInfoMixin]

    onPullDownRefresh() {
      console.log("xiala")
      if (this.page.pageIndex > this.page.totalPage) {
        wx.showToast({title:"帅哥美女库存已空，来推荐几个吧", icon: "none"})
        wx.stopPullDownRefresh();
      }else {
        this.$parent.commonRequest(this.$parent.globalData.backUrl + "user/queryByPage", this.page, this.topLoadData.bind(this), false);
      }
    }

    onReachBottom() {
      console.log("处理")
      if (this.page.pageIndex > this.page.totalPage) {
        this.noData = true;
      }else {
        this.$parent.commonRequest(this.$parent.globalData.backUrl + "user/queryByPage", this.page, this.downLoadData.bind(this), false);
      }
    }

    loadData(data) {
      console.log(data)
      this.dataList = data.dataList;
      this.page.pageIndex += 1;
      this.page.totalPage = data.totalPage;
      this.$apply();
    }

    topLoadData(data) {
      console.log(data)
      wx.stopPullDownRefresh();
      this.dataList.unshift(data.dataList);
      this.page.pageIndex += 1;
      this.page.totalPage = data.totalPage;
      this.$apply();
    }

    downLoadData(data) {
      console.log(data)
      this.dataList.push(data.dataList);
      this.page.pageIndex += 1;
      this.page.totalPage = data.totalPage;
      this.$apply();
    }

    getUserSuccess() {
      console.log("获得用户信息成功")
      // 开始获取数据
      this.$parent.commonRequest(this.$parent.globalData.backUrl + "user/queryByPage", this.page, this.loadData.bind(this), true);
    }

    onLoad() {
      console.log("注册用户授权事件")
      this.$parent.globalData.eventBus.on("getuser", this.getUserSuccess.bind(this))
    }
  }
</script>
